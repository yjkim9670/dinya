<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포트폴리오 트레이딩 콘솔</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #333333;
            --accent-blue: #00bcd4;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --border-color: #444444;
            --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        /* --- 기본 및 레이아웃 --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh;
            gap: 1rem;
            padding: 1rem;
        }

        .navbar {
            grid-column: 1 / -1;
            background-color: var(--bg-secondary);
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            font-size: 1.5rem;
            color: var(--accent-blue);
        }

        .hamburger {
            display: none;
            cursor: pointer;
            font-size: 2rem;
        }

        .sidebar {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, height 0.3s ease-in-out;
        }

        .main-content {
            overflow-y: auto;
            border-radius: 8px;
        }

        /* --- 카드 공통 스타일 --- */
        .card {
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent-blue);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* --- 사이드바 --- */
        #portfolio-summary .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        #portfolio-summary .summary-item span:first-child {
            color: var(--text-secondary);
        }

        #holdings-list .holding-item {
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 5px;
            background-color: var(--bg-tertiary);
            transition: background-color 0.2s;
        }
        
        #holdings-list .holding-item:hover {
            background-color: #444;
        }

        .holding-item-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }

        .holding-item-details, .holding-item-pnl {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.2rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .holding-item-pnl {
            font-weight: bold;
        }

        .holding-item-footer {
            margin-top: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- 메인 콘텐츠 --- */
        .tabs {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .tab-btn {
            padding: 0.6rem 1.2rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            font-weight: bold;
            border-color: var(--accent-blue);
        }

        .ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }

        .ticker-card {
            background-color: var(--bg-secondary);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: all 0.3s ease;
        }
        
        .ticker-card.holding {
            border-left: 4px solid var(--accent-blue);
        }

        .ticker-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .ticker-header h3 {
            font-size: 1.3rem;
        }

        .ticker-price {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .ticker-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .ticker-indicators {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .ticker-chart-container {
            height: 150px;
        }

        .ticker-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: auto;
        }

        /* --- 유틸리티 & 컴포넌트 --- */
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-secondary { color: var(--text-secondary); }

        .badge {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            color: var(--text-primary);
        }
        .badge-buy { background-color: var(--success); }
        .badge-sell { background-color: var(--danger); }
        .badge-hold { background-color: var(--warning); }
        .badge-neutral { background-color: #607d8b; }
        .badge-holding { background-color: var(--accent-blue); color: var(--bg-primary); }

        .btn {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.8; }
        .btn-primary { background-color: var(--accent-blue); color: var(--bg-primary); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-danger { background-color: var(--danger); color: var(--text-primary); }
        .btn-full { width: 100%; }

        /* --- 모달 --- */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal.visible .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            margin-bottom: 1.5rem;
            color: var(--accent-blue);
        }
        
        #holding-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        #holding-form input {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* --- 반응형 디자인 --- */
        @media (max-width: 1023px) {
            .container {
                grid-template-columns: 250px 1fr;
            }
            .ticker-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 767px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                height: auto;
                min-height: 100vh;
            }
            .navbar {
                position: sticky;
                top: 0;
                z-index: 10;
            }
            .hamburger {
                display: block;
            }
            .sidebar {
                grid-row: 2;
                max-height: 0;
                padding: 0 1rem;
                overflow: hidden;
                transform: translateY(-10px);
                opacity: 0;
            }
            .sidebar.open {
                max-height: 1000px; /* 충분히 큰 값 */
                padding: 1rem;
                transform: translateY(0);
                opacity: 1;
            }
            .main-content {
                grid-row: 3;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <h1>트레이딩 콘솔</h1>
            <div class="hamburger" id="hamburger-menu">☰</div>
        </nav>

        <aside class="sidebar" id="sidebar">
            <div id="portfolio-summary" class="card"></div>
            <div id="portfolio-chart-container" class="card">
                <h3 class="card-title">포트폴리오 비중</h3>
                <canvas id="portfolio-chart"></canvas>
            </div>
            <div id="holdings-list-container" class="card">
                <h3 class="card-title">보유 종목</h3>
                <div id="holdings-list"></div>
            </div>
        </aside>

        <main class="main-content">
            <div class="tabs">
                <button class="tab-btn active" data-tab="stocks">주식</button>
                <button class="tab-btn" data-tab="etfs">ETF</button>
                <button class="tab-btn" data-tab="crypto">암호화폐</button>
            </div>
            <div id="ticker-grid" class="ticker-grid"></div>
        </main>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <form id="holding-form">
                <input type="hidden" id="symbol">
                <div>
                    <label for="quantity">보유 수량</label>
                    <input type="number" id="quantity" step="any" min="0" required>
                </div>
                <div>
                    <label for="avgPrice">평균 매수가 (원)</label>
                    <input type="number" id="avgPrice" step="any" min="0" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="modal-close">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

<script>
// ========== 전역 상태 및 상수 ==========
let portfolio = { cash: 10000000, holdings: {} };
let currentTab = 'stocks';
let chartInstances = {};
let portfolioDoughnutChart = null;

// ========== Mock 데이터 생성 ==========
const generatePriceHistory = (base, volatility, days = 90) => {
    let prices = [];
    let currentPrice = base;
    for (let i = 0; i < days; i++) {
        prices.push(currentPrice);
        currentPrice *= 1 + (Math.random() - 0.5) * volatility;
    }
    return prices.reverse();
};

const mockData = {
    stocks: {
        "005930.KS": { name: "삼성전자", price: 83000, change: -1.2, volume: 15230000, marketCap: "495조", priceHistory: generatePriceHistory(85000, 0.03), indicators: { sma5: 82500, sma20: 81000, rsi: 55, stochasticK: 60, macd: 150 }, score: 68 },
        "000660.KS": { name: "SK하이닉스", price: 215000, change: 2.5, volume: 4500000, marketCap: "156조", priceHistory: generatePriceHistory(200000, 0.05), indicators: { sma5: 218000, sma20: 205000, rsi: 72, stochasticK: 85, macd: 2500 }, score: 85 },
    },
    etfs: {
        "360750.KS": { name: "TIGER S&P500", price: 18500, change: 0.8, volume: 800000, marketCap: "5조", priceHistory: generatePriceHistory(18000, 0.02), indicators: { sma5: 18400, sma20: 18200, rsi: 65, stochasticK: 70, macd: 50 }, score: 75 },
        "133690.KS": { name: "TIGER 나스닥100", price: 112000, change: 1.5, volume: 650000, marketCap: "8조", priceHistory: generatePriceHistory(108000, 0.03), indicators: { sma5: 113000, sma20: 110000, rsi: 70, stochasticK: 80, macd: 800 }, score: 80 },
    },
    crypto: {
        "BTC-KRW": { name: "비트코인", price: 98500000, change: 3.2, volume: 245.7, marketCap: "1,950조", priceHistory: generatePriceHistory(95000000, 0.08), indicators: { sma5: 97000000, sma20: 92000000, rsi: 68, stochasticK: 75, macd: 1500000 }, score: 82 },
        "ETH-KRW": { name: "이더리움", price: 4850000, change: 2.1, volume: 3500, marketCap: "580조", priceHistory: generatePriceHistory(4700000, 0.1), indicators: { sma5: 4800000, sma20: 4600000, rsi: 62, stochasticK: 65, macd: 80000 }, score: 70 },
        "XRP-KRW": { name: "리플", price: 680, change: -2.5, volume: 150000000, marketCap: "37조", priceHistory: generatePriceHistory(700, 0.15), indicators: { sma5: 670, sma20: 690, rsi: 35, stochasticK: 25, macd: -5 }, score: 35 },
        "SOL-KRW": { name: "솔라나", price: 195000, change: 5.5, volume: 850000, marketCap: "90조", priceHistory: generatePriceHistory(180000, 0.12), indicators: { sma5: 198000, sma20: 185000, rsi: 75, stochasticK: 88, macd: 5000 }, score: 92 },
    }
};

// ========== 포트폴리오 관리 함수 ==========
function loadPortfolio() {
    try {
        const savedPortfolio = localStorage.getItem('tradingConsolePortfolio');
        if (savedPortfolio) {
            portfolio = JSON.parse(savedPortfolio);
        }
    } catch (e) {
        console.error("포트폴리오 로딩 실패:", e);
        alert("localStorage에서 포트폴리오를 불러오는 데 실패했습니다.");
    }
}

function savePortfolio() {
    try {
        localStorage.setItem('tradingConsolePortfolio', JSON.stringify(portfolio));
    } catch (e) {
        console.error("포트폴리오 저장 실패:", e);
        alert("localStorage에 포트폴리오를 저장하는 데 실패했습니다.");
    }
}

function addOrUpdateHolding(symbol, quantity, avgPrice) {
    portfolio.holdings[symbol] = { quantity, avgPrice, addedDate: new Date().toISOString() };
    savePortfolio();
    renderAll();
}

function removeHolding(symbol) {
    if (confirm(`${symbol} 종목을 포트폴리오에서 삭제하시겠습니까?`)) {
        delete portfolio.holdings[symbol];
        savePortfolio();
        renderAll();
    }
}


// ========== 계산 함수 ==========
const getAssetData = (symbol) => {
    for (const type in mockData) {
        if (mockData[type][symbol]) {
            return mockData[type][symbol];
        }
    }
    return null;
};

function calculatePortfolioValue() {
    let totalHoldingsValue = 0;
    for (const symbol in portfolio.holdings) {
        const holding = portfolio.holdings[symbol];
        const assetData = getAssetData(symbol);
        if (assetData) {
            totalHoldingsValue += holding.quantity * assetData.price;
        }
    }
    return {
        totalHoldingsValue,
        totalAssets: totalHoldingsValue + portfolio.cash
    };
}

function calculateTotalPrincipal() {
    let totalPrincipal = 0;
    for (const symbol in portfolio.holdings) {
        const holding = portfolio.holdings[symbol];
        totalPrincipal += holding.quantity * holding.avgPrice;
    }
    return totalPrincipal;
}

/**
 * 포지션 조정 추천 로직
 * @param {string} symbol - 종목 심볼
 * @param {number} score - 기술적 분석 점수 (0-100)
 * @param {number} currentWeight - 현재 포트폴리오 비중 (%)
 * @returns {{action: string, message: string, className: string}} 추천 결과
 */
function getPositionRecommendation(symbol, score, currentWeight) {
    const pnl = calculateProfitLoss(symbol);
    
    if (score <= 20) {
        return { action: "전량 매도", message: `손절 권장: 현재 손익 ${pnl.percent.toFixed(2)}%`, className: "badge-sell" };
    }
    if (score >= 80 && currentWeight < 5) {
        return { action: "매수 추가", message: `현재 비중 ${currentWeight.toFixed(1)}% → 권장 비중 10%로 증액`, className: "badge-buy" };
    }
    if (score >= 20 && score <= 50 && currentWeight >= 15) {
        return { action: "일부 매도", message: `현재 비중 ${currentWeight.toFixed(1)}% → 권장 비중 5%로 감축`, className: "badge-sell" };
    }
    return { action: "홀드", message: "현재 포지션 유지", className: "badge-hold" };
}

function calculateProfitLoss(symbol) {
    const holding = portfolio.holdings[symbol];
    const assetData = getAssetData(symbol);
    if (!holding || !assetData) return { amount: 0, percent: 0 };

    const principal = holding.quantity * holding.avgPrice;
    const currentValue = holding.quantity * assetData.price;
    const pnlAmount = currentValue - principal;
    const pnlPercent = principal > 0 ? (pnlAmount / principal) * 100 : 0;
    return { amount: pnlAmount, percent: pnlPercent };
}


// ========== UI 렌더링 함수 ==========
function formatCurrency(value, decimals = 0) {
    return new Intl.NumberFormat('ko-KR', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals,
    }).format(value);
}

function renderPortfolioSummary() {
    const summaryEl = document.getElementById('portfolio-summary');
    const { totalHoldingsValue, totalAssets } = calculatePortfolioValue();
    const totalPrincipal = calculateTotalPrincipal();
    const totalPnlAmount = totalAssets - portfolio.cash - totalPrincipal;
    const totalPnlPercent = totalPrincipal > 0 ? (totalPnlAmount / totalPrincipal) * 100 : 0;

    summaryEl.innerHTML = `
        <h3 class="card-title">요약</h3>
        <div class="summary-item"><span>총 자산 평가액</span> <span>${formatCurrency(totalAssets)}원</span></div>
        <div class="summary-item"><span>총 투자 원금</span> <span>${formatCurrency(totalPrincipal)}원</span></div>
        <div class="summary-item">
            <span>총 평가 손익</span>
            <span class="${totalPnlAmount >= 0 ? 'text-success' : 'text-danger'}">
                ${formatCurrency(totalPnlAmount)}원 (${totalPnlPercent.toFixed(2)}%)
            </span>
        </div>
        <div class="summary-item"><span>현금 잔고</span> <span>${formatCurrency(portfolio.cash)}원</span></div>
    `;
}

function renderHoldingsList() {
    const listEl = document.getElementById('holdings-list');
    const { totalAssets } = calculatePortfolioValue();
    listEl.innerHTML = '';

    const holdingsArray = Object.keys(portfolio.holdings);

    if (holdingsArray.length === 0) {
        listEl.innerHTML = '<p class="text-secondary">보유 중인 종목이 없습니다.</p>';
        return;
    }

    holdingsArray.forEach(symbol => {
        const holding = portfolio.holdings[symbol];
        const assetData = getAssetData(symbol);
        if (!assetData) return;

        const currentValue = holding.quantity * assetData.price;
        const pnl = calculateProfitLoss(symbol);
        const weight = totalAssets > 0 ? (currentValue / totalAssets) * 100 : 0;
        const recommendation = getPositionRecommendation(symbol, assetData.score, weight);

        const itemEl = document.createElement('div');
        itemEl.className = 'holding-item';
        itemEl.innerHTML = `
            <div class="holding-item-header">
                <span>${assetData.name} (${symbol})</span>
                <span class="${pnl.amount >= 0 ? 'text-success' : 'text-danger'}">${pnl.percent.toFixed(2)}%</span>
            </div>
            <div class="holding-item-details">
                <span>보유수량</span><span>${formatCurrency(holding.quantity, 4)}</span>
                <span>평균매수가</span><span>${formatCurrency(holding.avgPrice)}원</span>
                <span>현재가</span><span>${formatCurrency(assetData.price)}원</span>
                <span>현재비중</span><span>${weight.toFixed(2)}%</span>
            </div>
            <div class="holding-item-pnl">
                <span>평가손익</span>
                <span class="${pnl.amount >= 0 ? 'text-success' : 'text-danger'}">${formatCurrency(pnl.amount)}원</span>
            </div>
            <div class="holding-item-footer">
                <span class="badge ${recommendation.className}">${recommendation.action}</span>
                <span class="text-secondary" style="font-size:0.75rem">${recommendation.message}</span>
            </div>
        `;
        listEl.appendChild(itemEl);
    });
}

function renderPortfolioChart() {
    const ctx = document.getElementById('portfolio-chart').getContext('2d');
    const { totalAssets } = calculatePortfolioValue();
    
    const labels = [];
    const data = [];
    const colors = ['#00bcd4', '#4caf50', '#ff9800', '#f44336', '#9c27b0', '#3f51b5', '#03a9f4', '#8bc34a'];
    
    let colorIndex = 0;
    for (const symbol in portfolio.holdings) {
        const holding = portfolio.holdings[symbol];
        const assetData = getAssetData(symbol);
        if (assetData) {
            labels.push(assetData.name);
            data.push(holding.quantity * assetData.price);
        }
    }
    
    if (portfolio.cash > 0) {
        labels.push('현금');
        data.push(portfolio.cash);
    }
    
    if (portfolioDoughnutChart) {
        portfolioDoughnutChart.destroy();
    }
    
    if (data.length === 0 || totalAssets === 0) {
        document.getElementById('portfolio-chart-container').style.display = 'none';
        return;
    }
    
    document.getElementById('portfolio-chart-container').style.display = 'block';

    portfolioDoughnutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: labels.map(() => colors[colorIndex++ % colors.length]),
                borderColor: 'var(--bg-secondary)',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: 'var(--text-secondary)',
                        boxWidth: 12,
                        padding: 15,
                    }
                }
            },
            cutout: '60%'
        }
    });
}

function renderTickerGrid() {
    const gridEl = document.getElementById('ticker-grid');
    gridEl.innerHTML = '';
    const dataSet = mockData[currentTab];
    for (const symbol in dataSet) {
        const data = dataSet[symbol];
        const isHolding = !!portfolio.holdings[symbol];
        const card = renderTickerCard(symbol, data, isHolding);
        gridEl.appendChild(card);
    }
}

function getScoreBadge(score) {
    if (score >= 80) return { text: '강력 매수', className: 'badge-buy' };
    if (score >= 60) return { text: '매수', className: 'badge-buy' };
    if (score >= 40) return { text: '관망', className: 'badge-neutral' };
    if (score >= 20) return { text: '매도', className: 'badge-sell' };
    return { text: '강력 매도', className: 'badge-sell' };
}

function renderTickerCard(symbol, data, isHolding) {
    const cardEl = document.createElement('div');
    cardEl.className = `ticker-card ${isHolding ? 'holding' : ''}`;
    cardEl.dataset.symbol = symbol;

    const changeClass = data.change >= 0 ? 'text-success' : 'text-danger';
    const scoreBadge = getScoreBadge(data.score);

    let portfolioSection = '';
    if (isHolding) {
        const holding = portfolio.holdings[symbol];
        const pnl = calculateProfitLoss(symbol);
        portfolioSection = `
            <div class="ticker-portfolio-info">
                <hr style="border-color: var(--border-color); margin: 0.5rem 0;">
                <div class="ticker-info-grid">
                    <span>보유수량</span><span>${formatCurrency(holding.quantity, 4)}</span>
                    <span>평균단가</span><span>${formatCurrency(holding.avgPrice)}원</span>
                    <span>평가손익</span><span class="${pnl.amount >= 0 ? 'text-success' : 'text-danger'}">${pnl.percent.toFixed(2)}%</span>
                </div>
            </div>
        `;
    }

    cardEl.innerHTML = `
        <div class="ticker-header">
            <div>
                <h3>${data.name} <span class="text-secondary">${symbol}</span></h3>
                <span class="ticker-price">${formatCurrency(data.price)}원</span>
                <span class="${changeClass}">${data.change >= 0 ? '▲' : '▼'} ${Math.abs(data.change)}%</span>
            </div>
            <div>
                ${isHolding ? '<span class="badge badge-holding">보유 중 ✓</span>' : ''}
                <span class="badge ${scoreBadge.className}" style="margin-top: 5px; display: inline-block;">${scoreBadge.text} (${data.score})</span>
            </div>
        </div>
        <div class="ticker-info-grid">
            <span>거래량</span><span>${formatCurrency(data.volume)}</span>
            <span>시가총액</span><span>${data.marketCap}</span>
        </div>
        <div class="ticker-indicators">
            <span>SMA(5/20)</span><span>${formatCurrency(data.indicators.sma5)} / ${formatCurrency(data.indicators.sma20)}</span>
            <span>RSI(14)</span><span>${data.indicators.rsi.toFixed(2)}</span>
            <span>Stochastic</span><span>${data.indicators.stochasticK.toFixed(2)}</span>
            <span>MACD</span><span>${formatCurrency(data.indicators.macd)}</span>
        </div>
        <div class="ticker-chart-container">
            <canvas id="chart-${symbol}"></canvas>
        </div>
        ${portfolioSection}
        <div class="ticker-actions">
            ${isHolding ? `
                <button class="btn btn-secondary btn-edit">수정</button>
                <button class="btn btn-danger btn-delete">삭제</button>
            ` : `
                <button class="btn btn-primary btn-add btn-full">포트폴리오에 추가</button>
            `}
        </div>
    `;

    // 차트 렌더링은 cardEl이 DOM에 추가된 후에 호출해야 합니다.
    // setTimeout을 사용하여 다음 렌더링 사이클에 실행하도록 합니다.
    setTimeout(() => {
        const ctx = document.getElementById(`chart-${symbol}`)?.getContext('2d');
        if (ctx) {
            if (chartInstances[symbol]) {
                chartInstances[symbol].destroy();
            }
            chartInstances[symbol] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 30 }, (_, i) => i + 1),
                    datasets: [{
                        label: '가격',
                        data: data.priceHistory.slice(-30),
                        borderColor: 'var(--accent-blue)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    }, 0);

    return cardEl;
}

// ========== 모달 관리 ==========
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const form = document.getElementById('holding-form');
const symbolInput = document.getElementById('symbol');
const quantityInput = document.getElementById('quantity');
const avgPriceInput = document.getElementById('avgPrice');

function showModal(symbol, isEdit = false) {
    const assetData = getAssetData(symbol);
    form.reset();
    symbolInput.value = symbol;

    if (isEdit) {
        const holding = portfolio.holdings[symbol];
        modalTitle.textContent = `${assetData.name} 수정`;
        quantityInput.value = holding.quantity;
        avgPriceInput.value = holding.avgPrice;
    } else {
        modalTitle.textContent = `${assetData.name} 추가`;
    }
    modal.classList.add('visible');
}

function closeModal() {
    modal.classList.remove('visible');
}

function handleFormSubmit(e) {
    e.preventDefault();
    const symbol = symbolInput.value;
    const quantity = parseFloat(quantityInput.value);
    const avgPrice = parseFloat(avgPriceInput.value);

    if (quantity < 0 || avgPrice < 0) {
        alert("수량과 가격은 음수일 수 없습니다.");
        return;
    }

    addOrUpdateHolding(symbol, quantity, avgPrice);
    closeModal();
}

// ========== 이벤트 리스너 ==========
document.addEventListener('DOMContentLoaded', () => {
    loadPortfolio();
    renderAll();

    // 탭 전환
    document.querySelector('.tabs').addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-btn')) {
            document.querySelector('.tab-btn.active').classList.remove('active');
            e.target.classList.add('active');
            currentTab = e.target.dataset.tab;
            renderTickerGrid();
        }
    });

    // 종목 카드 내 버튼 (이벤트 위임)
    document.getElementById('ticker-grid').addEventListener('click', (e) => {
        const card = e.target.closest('.ticker-card');
        if (!card) return;
        const symbol = card.dataset.symbol;

        if (e.target.classList.contains('btn-add')) {
            showModal(symbol, false);
        } else if (e.target.classList.contains('btn-edit')) {
            showModal(symbol, true);
        } else if (e.target.classList.contains('btn-delete')) {
            removeHolding(symbol);
        }
    });
    
    // 모바일 햄버거 메뉴
    document.getElementById('hamburger-menu').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('open');
    });

    // 모달 관련
    document.getElementById('modal-close').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    form.addEventListener('submit', handleFormSubmit);
});

function renderAll() {
    renderPortfolioSummary();
    renderHoldingsList();
    renderPortfolioChart();
    renderTickerGrid();
}
</script>
</body>
</html>
