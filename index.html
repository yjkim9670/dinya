<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>카톡 대화 인포그래픽 — 날짜별 발화 & 키워드 분류</title>
<style>
  :root { --bg:#0b1220; --card:#121a2b; --ink:#e9eefb; --muted:#9fb1d1; --accent:#7cc4ff; --grid:#22304a; }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Malgun Gothic,Arial}
  header{padding:20px 24px;border-bottom:1px solid var(--grid);display:flex;gap:12px;align-items:center}
  header h1{font-size:18px;margin:0}
  main{display:grid;grid-template-columns:420px 1fr;gap:16px;padding:16px}
  .panel{background:var(--card);border:1px solid var(--grid);border-radius:14px}
  .panel h2{font-size:14px;color:var(--muted);margin:0;padding:14px 16px;border-bottom:1px solid var(--grid)}
  .pad{padding:14px 16px}
  textarea{width:100%;height:360px;background:#0e1525;color:var(--ink);border:1px solid var(--grid);border-radius:10px;padding:12px;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace}
  button{all:unset;background:linear-gradient(90deg,#4aa3ff,#9ae6ff);color:#05213a;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
  button:active{transform:translateY(1px)}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .kpi{background:#0e1525;border:1px solid var(--grid);border-radius:12px;padding:12px}
  .kpi b{font-size:20px;display:block}
  .legend{display:flex;flex-wrap:wrap;gap:8px}
  .pill{background:#0e1525;border:1px solid var(--grid);border-radius:999px;padding:6px 10px;color:var(--muted)}
  canvas{width:100%;height:320px;border-radius:12px;background:#0e1525;border:1px solid var(--grid)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid var(--grid);text-align:left}
  th{color:var(--muted);font-weight:600}
  .note{color:var(--muted);font-size:12px}
  .footer{padding:10px 16px;color:var(--muted);border-top:1px solid var(--grid);font-size:12px}
</style>
</head>
<body>
  <header>
    <h1>카톡 대화 인포그래픽</h1>
    <div class="pill">날짜별 발화 · 키워드별 분류</div>
  </header>

  <main>
    <!-- 입력 패널 -->
    <section class="panel">
      <h2>① 원문 붙여넣기</h2>
      <div class="pad">
        <textarea id="raw" placeholder="카카오톡 내보내기 원문을 그대로 붙여넣으세요 (예: 2025년 8월 9일 오전 10:22, 2322동 달토끼 : ... )"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="analyze">분석하기</button>
          <span class="note">포맷 예시: <em>YYYY년 M월 D일 오전/오후 h:mm, 닉네임 : 메시지</em></span>
        </div>
      </div>
    </section>

    <!-- 결과 패널 -->
    <section class="panel" style="display:flex;flex-direction:column">
      <h2>② 결과</h2>
      <div class="pad">
        <div class="kpis">
          <div class="kpi"><span>전체 발화(건)</span><b id="kpi-total">-</b></div>
          <div class="kpi"><span>참여자(명)</span><b id="kpi-users">-</b></div>
          <div class="kpi"><span>기간(일)</span><b id="kpi-days">-</b></div>
        </div>
      </div>

      <div class="pad">
        <h3 style="margin:0 0 10px 0;font-size:15px;color:#cfe6ff">A. 날짜별 발화 빈도</h3>
        <canvas id="chart"></canvas>
        <div class="legend" id="legend"></div>
      </div>

      <div class="pad">
        <h3 style="margin:0 0 10px 0;font-size:15px;color:#cfe6ff">B. 키워드 분류(토픽별)</h3>
        <table id="topic-table">
          <thead><tr><th>토픽</th><th>키워드</th><th>건수</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer">Tip: 입력창에 그대로 붙여넣고 “분석하기”만 누르면 됩니다. (클라이언트 내 연산, 데이터 전송 없음)</div>
    </section>
  </main>

<script>
/* ======== 간단 파서: 카카오 형식 "날짜, 닉네임 : 메시지" ======== */
function parseLines(text){
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const items = [];
  const rx = /^(\d{4})년\s*(\d{1,2})월\s*(\d{1,2})일\s*(오전|오후)\s*(\d{1,2}):(\d{2}),\s*(.+?)\s*:\s*(.+)$/;
  for(const line of lines){
    const m = line.match(rx);
    if(!m) continue;
    let [_,y,mo,d,ap,h,mi,user,msg] = m;
    y=+y; mo=+mo; d=+d; h=+h; mi=+mi;
    if(ap==='오후' && h!==12) h+=12;
    if(ap==='오전' && h===12) h=0;
    const dt = new Date(y,mo-1,d,h,mi);
    const dateKey = `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    items.push({dateKey,user,msg,dt});
  }
  return items;
}

/* ======== 토픽 사전: 키워드 → 토픽 ======== */
const TOPIC_DEF = [
  { topic: '시설/헬스장', keys: ['헬스장','런닝머신','트레드밀','에어컨','거치대','패밀리풀','수영','아쿠아슈즈','구명조끼','월패드','공동현관'] },
  { topic: '나눔/장터', keys: ['나눔','드실분','가져가실분','갠톡','판매','무료','성분표'] },
  { topic: '과일트럭/상가', keys: ['과일','자두','포도','복숭아','황도','과일트럭','상가','분식집','간판'] },
  { topic: '의료/병원', keys: ['내과','정형외과','장염','MRI','CT','수액','처방','원장'] },
  { topic: '교통/단속/사고', keys: ['출차','단속','사고','정체','끼어든','얌체','IC','우회','사이렌'] },
  { topic: '공지/행사', keys: ['공지','행사','휴장','도서관','수업','프로그램','쿠폰'] },
  { topic: '기타/잡담', keys: [] }
];

/* ======== 간단 키워드 매칭 ======== */
function classifyMessage(msg){
  const m = msg.toLowerCase();
  for(const def of TOPIC_DEF){
    if(def.keys.some(k=> m.includes(k.toLowerCase()))) return def.topic;
  }
  return '기타/잡담';
}

/* ======== 차트 렌더링 (바닐라 Canvas) ======== */
function renderBarChart(canvas, labels, values){
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.clientWidth * devicePixelRatio;
  const H = canvas.height = canvas.clientHeight * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
  const pad = 28, innerW = canvas.clientWidth - pad*2, innerH = canvas.clientHeight - pad*2;
  const maxV = Math.max(1, Math.max(...values));
  // grid
  ctx.fillStyle = '#22304a';
  for(let i=0;i<=4;i++){
    const y = pad + innerH - (innerH*i/4);
    ctx.fillRect(pad, y, innerW, 1);
  }
  // bars
  const bw = innerW / (labels.length*1.2);
  const gap = bw*0.2;
  ctx.fillStyle = '#7cc4ff';
  labels.forEach((lab,i)=>{
    const v = values[i];
    const h = (v/maxV)* (innerH-4);
    const x = pad + i*(bw+gap);
    const y = pad + innerH - h;
    ctx.fillRect(x, y, bw, h);
  });
  // axes labels
  ctx.fillStyle = '#9fb1d1'; ctx.font = '12px system-ui';
  labels.forEach((lab,i)=>{
    const x = pad + i*(bw+gap) + bw/2;
    ctx.save(); ctx.translate(x, pad+innerH+14); ctx.rotate(-Math.PI/10);
    ctx.textAlign = 'center'; ctx.fillText(lab, 0, 0); ctx.restore();
  });
}

/* ======== 메인 ======== */
document.getElementById('analyze').addEventListener('click', ()=>{
  const text = document.getElementById('raw').value;
  const rows = parseLines(text);
  if(rows.length===0){ alert('카톡 형식의 줄을 찾지 못했습니다. 예시 형식을 확인하세요.'); return; }

  // KPI
  const total = rows.length;
  const users = new Set(rows.map(r=>r.user)).size;
  const dates = Array.from(new Set(rows.map(r=>r.dateKey))).sort();
  document.getElementById('kpi-total').textContent = total.toLocaleString('ko-KR');
  document.getElementById('kpi-users').textContent = users.toLocaleString('ko-KR');
  document.getElementById('kpi-days').textContent = dates.length.toLocaleString('ko-KR');

  // 날짜별 카운트
  const byDate = {};
  rows.forEach(r=> byDate[r.dateKey]=(byDate[r.dateKey]||0)+1 );
  const labels = Object.keys(byDate).sort();
  const values = labels.map(k=>byDate[k]);

  // 차트
  const cvs = document.getElementById('chart');
  renderBarChart(cvs, labels, values);

  // 키워드 분류
  const topicCount = {};
  const topicKeys = {};
  rows.forEach(r=>{
    const topic = classifyMessage(r.msg);
    topicCount[topic] = (topicCount[topic]||0)+1;
    (topicKeys[topic] ||= new Set());
    for(const def of TOPIC_DEF){
      if(def.topic===topic){
        def.keys.forEach(k=>{ if(k && r.msg.includes(k)) topicKeys[topic].add(k); });
      }
    }
  });

  const tbody = document.querySelector('#topic-table tbody');
  tbody.innerHTML = '';
  Object.entries(topicCount)
    .sort((a,b)=>b[1]-a[1])
    .forEach(([topic,count])=>{
      const tr = document.createElement('tr');
      const keys = topicKeys[topic] ? Array.from(topicKeys[topic]).sort().join(', ') : '';
      tr.innerHTML = `<td>${topic}</td><td>${keys||'-'}</td><td>${count.toLocaleString('ko-KR')}</td>`;
      tbody.appendChild(tr);
    });
});
</script>
</body>
</html>
