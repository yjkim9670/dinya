<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>디에트르포레 수다방 대화 인텔리전스 대시보드</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
<style>
  :root {
    color-scheme: dark;
    --bg: #080f1e;
    --panel: #111a2d;
    --border: #243550;
    --ink: #e9eefb;
    --muted: #96a7c6;
    --accent: #7cc4ff;
    --accent-2: #2ef1b3;
    --danger: #ff8ea6;
    --mono: ui-monospace, Menlo, Consolas, 'Apple SD Gothic Neo', monospace;
    --sans: 'Pretendard', 'Apple SD Gothic Neo', 'Malgun Gothic', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: radial-gradient(circle at top left, rgba(57,93,153,0.22), transparent 45%), var(--bg);
    color: var(--ink);
    font-family: var(--sans);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    padding: 24px clamp(16px, 4vw, 40px) 12px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 12px;
  }
  header h1 {
    margin: 0;
    font-size: clamp(22px, 3vw, 30px);
    font-weight: 700;
  }
  header p {
    margin: 4px 0 0;
    color: var(--muted);
    max-width: 680px;
  }
  .layout {
    flex: 1;
    display: grid;
    grid-template-columns: minmax(280px, 360px) 1fr;
    gap: 18px;
    padding: clamp(16px, 4vw, 36px);
  }
  aside,
  main {
    display: flex;
    flex-direction: column;
    gap: 18px;
  }
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 22px;
    box-shadow: 0 18px 40px rgba(3,11,27,0.45);
  }
  .panel h2 {
    margin-top: 0;
    font-size: 16px;
    letter-spacing: 0.02em;
    color: #cfe6ff;
  }
  .panel h3 {
    margin-top: 0;
    font-size: 15px;
    color: #cfe6ff;
  }
  .panel p {
    color: var(--muted);
    font-size: 14px;
    line-height: 1.6;
  }
  .panel a {
    color: var(--accent);
    text-decoration: none;
  }
  .panel a:hover {
    text-decoration: underline;
  }
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 14px;
  }
  .kpi {
    border-radius: 14px;
    border: 1px solid rgba(127, 203, 255, 0.2);
    background: linear-gradient(160deg, rgba(124,196,255,0.18), rgba(7,15,31,0.4));
    padding: 18px;
  }
  .kpi .label {
    color: var(--muted);
    font-size: 13px;
  }
  .kpi .value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    margin-top: 6px;
  }
  .kpi .note {
    color: rgba(233,238,251,0.7);
    font-size: 12px;
    margin-top: 8px;
    display: block;
  }
  .chart {
    width: 100%;
    height: clamp(260px, 32vw, 420px);
  }
  .chart.small {
    height: clamp(220px, 28vw, 320px);
  }
  dl.meta {
    margin: 0;
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px 16px;
    font-size: 14px;
  }
  dl.meta dt {
    color: var(--muted);
  }
  dl.meta dd {
    margin: 4px 0 0;
    font-weight: 600;
  }
  .preview {
    font-family: var(--mono);
    font-size: 12px;
    background: rgba(6,14,28,0.8);
    border: 1px solid rgba(124,196,255,0.15);
    border-radius: 12px;
    padding: 14px;
    max-height: 220px;
    overflow: auto;
    line-height: 1.5;
    white-space: pre-wrap;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(124,196,255,0.1);
    color: var(--accent);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .keyword-timeline {
    max-height: 360px;
    overflow: auto;
    margin-top: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  details {
    border: 1px solid rgba(124,196,255,0.18);
    border-radius: 12px;
    padding: 10px 14px;
    background: rgba(9,16,30,0.6);
  }
  details summary {
    cursor: pointer;
    color: #cfe6ff;
    font-weight: 600;
  }
  details[open] {
    background: rgba(14,25,46,0.9);
  }
  details ul {
    margin: 12px 0 0;
    padding-left: 18px;
    font-size: 13px;
    color: var(--muted);
  }
  table.participants {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
    font-size: 13px;
  }
  table.participants th,
  table.participants td {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  table.participants th {
    color: var(--muted);
    text-align: left;
    font-weight: 500;
  }
  .insights-shell {
    background: rgba(8,13,24,0.7);
    border-radius: 14px;
    border: 1px solid rgba(124,196,255,0.12);
    padding: 18px;
    max-height: 420px;
    overflow: auto;
  }
  .insights-shell article {
    font-size: 14px;
    line-height: 1.65;
  }
  .insights-shell h2,
  .insights-shell h3 {
    margin-top: 18px;
  }
  footer {
    padding: 24px;
    text-align: center;
    font-size: 12px;
    color: rgba(233,238,251,0.5);
  }
  @media (max-width: 1080px) {
    .layout {
      grid-template-columns: 1fr;
    }
    aside {
      order: 2;
    }
    main {
      order: 1;
    }
  }
  @media (max-width: 640px) {
    header {
      padding-bottom: 0;
    }
    .panel {
      padding: 18px;
    }
    .chart {
      height: 280px;
    }
  }
</style>
<script src="data/datasets.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js" defer></script>
</head>
<body>
<header>
  <div>
    <h1>디에트르포레 수다방 대화 인텔리전스 대시보드</h1>
    <p>카카오톡 오픈채팅방 전체 대화(<span id="header-range"></span>)를 기반으로 날짜·시간대별 발화량, 핵심 키워드, 참여자 활동, 그리고 KOSPI·S&P500 주가지수 흐름을 함께 탐색할 수 있도록 구성한 정적 대시보드입니다. 그래프에 커서를 올리거나 탭을 확장하여 세부 데이터를 확인하세요.</p>
  </div>
  <span class="pill">FULL TRANSCRIPT EMBEDDED</span>
</header>

<div class="layout">
  <aside>
    <section class="panel">
      <h2>데이터 소스 & 연결</h2>
      <p>원문 전체와 분석 리포트를 HTML로 내장하여 별도 복사 없이 언제든 검토할 수 있습니다.</p>
      <ul style="margin:12px 0 0; padding-left:18px; color:var(--muted); font-size:14px; line-height:1.6;">
        <li><a href="conversation_full.html" target="_blank" rel="noopener">대화 원문 전체 보기</a></li>
        <li><a href="insights.html" target="_blank" rel="noopener">심층 분석 리포트 열기</a></li>
        <li><a href="#insights">대시보드 내 요약 섹션으로 이동</a></li>
      </ul>
    </section>
    <section class="panel">
      <h2>기간 요약</h2>
      <dl class="meta" id="meta"></dl>
    </section>
    <section class="panel">
      <h2>대화 원문 프리뷰</h2>
      <div class="preview" id="preview"></div>
      <p style="margin-top:12px; font-size:12px;">전체 원문은 상단 링크를 통해 전용 페이지에서 전문 검색 및 스크롤이 가능합니다.</p>
    </section>
    <section class="panel">
      <h2>주요 참여자 TOP 12</h2>
      <div id="participants-chart" class="chart small"></div>
      <table class="participants" id="participants-table">
        <thead><tr><th>참여자</th><th>발화 수</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </aside>

  <main>
    <section class="panel">
      <h2>핵심 KPI</h2>
      <div class="kpi-grid">
        <div class="kpi">
          <span class="label">총 메시지</span>
          <span class="value" id="kpi-total">-</span>
          <span class="note">전체 대화 건수</span>
        </div>
        <div class="kpi">
          <span class="label">참여자 수</span>
          <span class="value" id="kpi-users">-</span>
          <span class="note">고유 닉네임 기준</span>
        </div>
        <div class="kpi">
          <span class="label">활성 일수</span>
          <span class="value" id="kpi-days">-</span>
          <span class="note">최소 1건 이상 발화한 날짜</span>
        </div>
        <div class="kpi">
          <span class="label">일 평균 발화</span>
          <span class="value" id="kpi-average">-</span>
          <span class="note">총 메시지 ÷ 활성 일수</span>
        </div>
        <div class="kpi">
          <span class="label">최다 발화일</span>
          <span class="value" id="kpi-busiest">-</span>
          <span class="note" id="kpi-busiest-note"></span>
        </div>
        <div class="kpi">
          <span class="label">피크 시간대</span>
          <span class="value" id="kpi-peak-hour">-</span>
          <span class="note" id="kpi-peak-note"></span>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>날짜별 발화량 vs. KOSPI · S&P500</h2>
      <div id="trend-chart" class="chart" role="img" aria-label="날짜별 메시지 수와 주가지수 추이를 보여주는 복합 그래프"></div>
      <p>막대는 날짜별 발화 건수, 선 그래프는 동일 날짜의 KOSPI와 S&P500 종가 흐름을 나타냅니다. 포인트를 선택하면 해당 날짜의 키워드와 발화량을 함께 확인할 수 있습니다.</p>
    </section>

    <section class="panel">
      <h2>시간대별 발화 패턴 (히트맵)</h2>
      <div id="heatmap-chart" class="chart" role="img" aria-label="날짜와 시간대별 발화량 히트맵"></div>
      <p>가장 밝은 영역이 집중 발화 시간대를 의미합니다. 회의·공지 등 특정 이벤트가 어느 시간대에 몰리는지 빠르게 파악할 수 있습니다.</p>
    </section>

    <section class="panel">
      <h2>시간대 누적 발화량</h2>
      <div id="hourly-chart" class="chart small" role="img" aria-label="시간대별 누적 발화량"></div>
      <p>하루 중 어느 시간대에 대화가 가장 활발한지 확인하고, 커뮤니티 운영 공지를 송출하기 좋은 타이밍을 도출합니다.</p>
    </section>

    <section class="panel">
      <h2>핵심 키워드 탐색</h2>
      <div id="keyword-chart" class="chart small" role="img" aria-label="전체 기간 핵심 키워드 빈도"></div>
      <div class="keyword-timeline" id="keyword-timeline"></div>
    </section>

    <section class="panel" id="insights">
      <h2>심층 분석 요약</h2>
      <div class="insights-shell" id="insights-shell"></div>
      <p style="margin-top:12px; font-size:13px;">전체 보고서는 <a href="insights.html" target="_blank" rel="noopener">insights.html</a>에서 별도 페이지로도 확인할 수 있습니다.</p>
    </section>
  </main>
</div>

<footer>
  데이터 처리 및 시각화는 모두 클라이언트에서 수행되며, 외부 서버로 전송되지 않습니다.
</footer>

<script>
window.addEventListener('load', () => {
  const metrics = window.CONVERSATION_METRICS;
  const market = window.MARKET_INDICES;
  const insightsArticle = window.CONVERSATION_INSIGHTS_SECTION;
  if (!metrics || !market) {
    console.error('데이터를 불러오지 못했습니다. scripts/build_data.mjs를 먼저 실행하세요.');
    return;
  }
  const fmt = (n) => n.toLocaleString('ko-KR');
  const meta = document.getElementById('meta');
  const summary = metrics.summary;
  const rangeEl = document.getElementById('header-range');
  if (rangeEl) {
    rangeEl.textContent = `${summary.firstDate} ~ ${summary.lastDate}`;
  }
  const metaHtml = [
    `<dt>대화 기간</dt><dd>${summary.firstDate} ~ ${summary.lastDate}</dd>`,
    `<dt>총 메시지</dt><dd>${fmt(summary.totalMessages)}</dd>`,
    `<dt>참여자</dt><dd>${fmt(summary.totalParticipants)}명</dd>`,
    `<dt>활성 일수</dt><dd>${fmt(summary.activeDays)}일</dd>`,
    `<dt>일 평균</dt><dd>${fmt(summary.averagePerDay)}</dd>`,
    `<dt>최다 발화일</dt><dd>${summary.busiestDate}</dd>`,
    `<dt>피크 시간대</dt><dd>${summary.peakHour}시</dd>`,
    `<dt>피크 건수</dt><dd>${fmt(summary.peakHourCount)}</dd>`
  ].join('');
  meta.innerHTML = metaHtml;

  document.getElementById('preview').textContent = metrics.transcriptPreview.join('\n');

  document.getElementById('kpi-total').textContent = fmt(summary.totalMessages);
  document.getElementById('kpi-users').textContent = fmt(summary.totalParticipants);
  document.getElementById('kpi-days').textContent = fmt(summary.activeDays);
  document.getElementById('kpi-average').textContent = fmt(summary.averagePerDay);
  document.getElementById('kpi-busiest').textContent = summary.busiestDate;
  document.getElementById('kpi-busiest-note').textContent = `${fmt(summary.busiestCount)}건 기록`;
  document.getElementById('kpi-peak-hour').textContent = `${summary.peakHour}시`;
  document.getElementById('kpi-peak-note').textContent = `${fmt(summary.peakHourCount)}건 누적`;

  const participants = metrics.participants.slice(0, 12);
  const participantNames = participants.map(p => p.user);
  const participantCounts = participants.map(p => p.count);

  const tableBody = document.querySelector('#participants-table tbody');
  tableBody.innerHTML = participants.map(p => `<tr><td>${p.user}</td><td>${fmt(p.count)}</td></tr>`).join('');

  function makeChart(el, options) {
    const chart = echarts.init(el);
    chart.setOption(options);
    window.addEventListener('resize', () => chart.resize());
    return chart;
  }

  makeChart(document.getElementById('participants-chart'), {
    tooltip: { trigger: 'item', formatter: '{b}: {c}건' },
    grid: { left: 80, right: 20, top: 20, bottom: 20 },
    xAxis: { type: 'value', axisLabel: { color: '#9fb1d1' }, splitLine: { lineStyle: { color: 'rgba(159,177,209,0.1)' } } },
    yAxis: { type: 'category', data: participantNames.reverse(), axisLabel: { color: '#cfe6ff' } },
    series: [{
      type: 'bar',
      data: participantCounts.reverse(),
      itemStyle: { color: '#7cc4ff' },
      label: { show: true, position: 'right', color: '#e9eefb' }
    }]
  });

  const dates = metrics.dailyMessages.map(d => d.date);
  const messageCounts = metrics.dailyMessages.map(d => d.count);
  const kospiSeries = market.kospi.map(d => ({ value: [d.date, d.close, d.change] }));
  const spxSeries = market.spx.map(d => ({ value: [d.date, d.close, d.change] }));

  const keywordLookup = metrics.keywords.byDate;
  const tooltipFormatter = (params) => {
    const date = params[0]?.axisValueLabel || params.axisValueLabel || '';
    const message = params.find(p => p.seriesName === '발화량');
    const kospiPoint = params.find(p => p.seriesName === 'KOSPI');
    const spxPoint = params.find(p => p.seriesName === 'S&P500');
    const keywords = keywordLookup[date] || [];
    const keywordStr = keywords.length ? keywords.map(k => `${k.keyword} (${k.count})`).join(', ') : '데이터 없음';
    return `
      <div style="min-width:220px">
        <strong>${date}</strong><br />
        발화량: ${message ? fmt(message.data) : '-'}건<br />
        KOSPI: ${kospiPoint ? kospiPoint.data[1].toLocaleString('ko-KR') : '-'} (Δ ${kospiPoint ? kospiPoint.data[2].toFixed(2) : '0'})<br />
        S&P500: ${spxPoint ? spxPoint.data[1].toLocaleString('en-US') : '-'} (Δ ${spxPoint ? spxPoint.data[2].toFixed(2) : '0'})<br />
        핵심 키워드: ${keywordStr}
      </div>`;
  };

  makeChart(document.getElementById('trend-chart'), {
    tooltip: { trigger: 'axis', axisPointer: { type: 'cross' }, formatter: tooltipFormatter },
    legend: { data: ['발화량', 'KOSPI', 'S&P500'], textStyle: { color: '#cfe6ff' } },
    grid: { top: 50, left: 60, right: 70, bottom: 60 },
    xAxis: { type: 'category', data: dates, axisLabel: { color: '#9fb1d1', rotate: 45 } },
    yAxis: [
      { type: 'value', name: '발화량', position: 'left', axisLabel: { color: '#9fb1d1' }, splitLine: { lineStyle: { color: 'rgba(159,177,209,0.08)' } } },
      { type: 'value', name: '지수', position: 'right', axisLabel: { color: '#9fb1d1' }, splitLine: { show: false } }
    ],
    dataZoom: [
      { type: 'slider', start: 0, end: 100, bottom: 10, textStyle: { color: '#cfe6ff' } },
      { type: 'inside' }
    ],
    series: [
      { name: '발화량', type: 'bar', data: messageCounts, itemStyle: { color: '#7cc4ff' }, emphasis: { focus: 'series' } },
      { name: 'KOSPI', type: 'line', yAxisIndex: 1, data: kospiSeries.map(d => d.value), smooth: true, itemStyle: { color: '#2ef1b3' } },
      { name: 'S&P500', type: 'line', yAxisIndex: 1, data: spxSeries.map(d => d.value), smooth: true, itemStyle: { color: '#ffb37a' } }
    ]
  });

  const heatmapDates = dates;
  const hours = Array.from({ length: 24 }, (_, i) => `${i}시`);
  const heatmapData = metrics.heatmap.map(item => [heatmapDates.indexOf(item.date), item.hour, item.value]);

  makeChart(document.getElementById('heatmap-chart'), {
    tooltip: {
      position: 'top',
      formatter: (params) => {
        const [xIdx, hour, value] = params.data;
        const date = heatmapDates[xIdx];
        return `${date} ${hour}시<br/>발화 ${fmt(value)}건`;
      }
    },
    grid: { top: 40, right: 20, left: 70, bottom: 40 },
    xAxis: { type: 'category', data: heatmapDates, splitArea: { show: true }, axisLabel: { color: '#9fb1d1', rotate: 45 } },
    yAxis: { type: 'category', data: hours, splitArea: { show: true }, axisLabel: { color: '#9fb1d1' } },
    visualMap: {
      min: 0,
      max: Math.max(...metrics.heatmap.map(h => h.value)),
      calculable: true,
      orient: 'horizontal',
      left: 'center',
      bottom: 10,
      textStyle: { color: '#cfe6ff' },
      inRange: { color: ['#0d1b2f', '#1f3c6d', '#61a0ff', '#d3f6ff'] }
    },
    series: [{
      name: '발화 히트맵',
      type: 'heatmap',
      data: heatmapData,
      label: { show: false }
    }]
  });

  makeChart(document.getElementById('hourly-chart'), {
    tooltip: { trigger: 'axis', formatter: (params) => `${params[0].axisValue}시 : ${fmt(params[0].data)}건` },
    grid: { top: 40, left: 50, right: 20, bottom: 40 },
    xAxis: { type: 'category', data: metrics.hourlyTotals.map(h => `${h.hour}시`), axisLabel: { color: '#9fb1d1' } },
    yAxis: { type: 'value', axisLabel: { color: '#9fb1d1' }, splitLine: { lineStyle: { color: 'rgba(159,177,209,0.1)' } } },
    series: [{
      data: metrics.hourlyTotals.map(h => h.count),
      type: 'line',
      smooth: true,
      areaStyle: { color: 'rgba(124,196,255,0.25)' },
      itemStyle: { color: '#7cc4ff' }
    }]
  });

  const keywordSeries = metrics.keywords.overall.map(k => ({ name: k.keyword, value: k.count }));
  makeChart(document.getElementById('keyword-chart'), {
    tooltip: { trigger: 'item', formatter: ({ name, value }) => `${name}: ${fmt(value)}회` },
    grid: { top: 20, bottom: 0, left: 0, right: 0 },
    series: [{
      name: '키워드',
      type: 'treemap',
      roam: false,
      nodeClick: false,
      breadcrumb: { show: false },
      data: keywordSeries.map(item => ({ name: item.name, value: item.value, itemStyle: { color: `rgba(${80 + (Math.random()*80)|0}, ${140 + (Math.random()*60)|0}, 255, 0.8)` } })),
      label: { color: '#0b1220', fontWeight: '600', overflow: 'truncate' }
    }]
  });

  const timeline = document.getElementById('keyword-timeline');
  const timelineDates = Object.keys(metrics.keywords.byDate).sort();
  timeline.innerHTML = timelineDates.map(date => {
    const list = metrics.keywords.byDate[date];
    const items = list && list.length ? list.map(item => `<li>${item.keyword} — ${fmt(item.count)}회</li>`).join('') : '<li>주요 키워드 데이터 없음</li>';
    return `<details><summary>${date}</summary><ul>${items}</ul></details>`;
  }).join('');

  const insightsShell = document.getElementById('insights-shell');
  insightsShell.innerHTML = insightsArticle;
});
</script>
</body>
</html>
